<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="android,dex,hidex," />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.0.2" />






<meta name="description" content="现在部分 app 出于安全性(比如加密算法)或者用户体验(热补丁修复bug)会考虑将部分模块采用热加载的形式 Load。所以针对这部分的 dex 进行加密是有必要的，如果 dex 是修复的加密算法，你总不想被人一下就反编译出来吧。当然也可以直接用一个加密算法对 dex 进行加密，Load 前进行解密就可以了，但是最好的加密就是让人分不清你是否加密了。一般逆向过程中拿到一个可以直接反编译成 java">
<meta property="og:type" content="article">
<meta property="og:title" content="DEX文件混淆加密">
<meta property="og:url" content="http://gnaixx.github.io/2017/02/06/20170206hidex-hack/index.html">
<meta property="og:site_name" content="凸一_一凸">
<meta property="og:description" content="现在部分 app 出于安全性(比如加密算法)或者用户体验(热补丁修复bug)会考虑将部分模块采用热加载的形式 Load。所以针对这部分的 dex 进行加密是有必要的，如果 dex 是修复的加密算法，你总不想被人一下就反编译出来吧。当然也可以直接用一个加密算法对 dex 进行加密，Load 前进行解密就可以了，但是最好的加密就是让人分不清你是否加密了。一般逆向过程中拿到一个可以直接反编译成 java">
<meta property="og:image" content="http://gnaixx.github.io/blog_images/20170206/compare-total.png">
<meta property="og:image" content="http://gnaixx.github.io/blog_images/20170206/field_ids.png">
<meta property="og:image" content="http://gnaixx.github.io/blog_images/20170206/compare-static.png">
<meta property="og:image" content="http://gnaixx.github.io/blog_images/20170206/virtual_methods.png">
<meta property="og:image" content="http://gnaixx.github.io/blog_images/20170206/compare-mutil-methods.png">
<meta property="og:image" content="http://gnaixx.github.io/blog_images/20170206/compare-hide-methods.png">
<meta property="og:image" content="http://gnaixx.github.io/blog_images/20170206/compare-class.png">
<meta property="og:image" content="http://gnaixx.github.io/blog_images/20170206/leb128.png">
<meta property="og:image" content="http://gnaixx.github.io/blog_images/20170206/hp.png">
<meta property="og:updated_time" content="2017-02-12T14:20:09.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DEX文件混淆加密">
<meta name="twitter:description" content="现在部分 app 出于安全性(比如加密算法)或者用户体验(热补丁修复bug)会考虑将部分模块采用热加载的形式 Load。所以针对这部分的 dex 进行加密是有必要的，如果 dex 是修复的加密算法，你总不想被人一下就反编译出来吧。当然也可以直接用一个加密算法对 dex 进行加密，Load 前进行解密就可以了，但是最好的加密就是让人分不清你是否加密了。一般逆向过程中拿到一个可以直接反编译成 java">
<meta name="twitter:image" content="http://gnaixx.github.io/blog_images/20170206/compare-total.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://gnaixx.github.io/2017/02/06/20170206hidex-hack/"/>


  <title> DEX文件混淆加密 | 凸一_一凸 </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?bb104a561bbdd3b6666195d45e5581a9";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">凸一_一凸</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">gnaixx</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                DEX文件混淆加密
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-02-06T23:24:44+08:00" content="2017-02-06">
              2017-02-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/02/06/20170206hidex-hack/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/06/20170206hidex-hack/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
              &nbsp; | &nbsp;
              <span class="page-pv"><i class="fa fa-file-o"></i>
              <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
              </span>
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>混淆加密主要是为了隐藏 dex 文件中关键的代码，力度从轻到重包括：静态变量的隐藏、函数的重复定义、函数的隐藏、以及整个类的隐藏。混淆后的 dex 文件依旧可以通过 dex2jar jade 等工具的反编译成 Java 源码，但是里面关键的代码已经看不到了。<br><strong>效果图：</strong><br><img src="/blog_images/20170206/compare-total.png" alt="效果图"></p>
<p>源码地址和使用说明在 github 上 <strong><a href="https://github.com/gnaixx/hidex-hack" target="_blank" rel="external">hidex-hack</a></strong></p>
<h2 id="0x01-dex格式分析"><a href="#0x01-dex格式分析" class="headerlink" title="0x01 dex格式分析"></a>0x01 dex格式分析</h2><p>dex 文件格式在上一篇有进行了比较详细的介绍，具体可看<strong><a href="http://gnaixx.cc/2016/11/26/20161126dex-file/" target="_blank" rel="external">dex文件格式分析</a></strong>，这里简单的介绍一下整个 dex 文件的布局。  </p>
<p><strong>1.header(dex头部)</strong><br>header 概述了整个 dex 文件的分布情况，包括了：<strong>magic</strong>, <strong>checksum</strong>, <strong>signature</strong>, <strong>file_size</strong>, <strong>header_size</strong>, <strong>endian_tag</strong>, <strong>link</strong>, <strong>map</strong>, <strong>string_ids</strong>, <strong>type_ids</strong>, <strong>proto_ids</strong>, <strong>field_ids</strong>, <strong>method_ids</strong>, <strong>class_defs</strong>, <strong>data</strong>。</p>
<ul>
<li><strong>checksum</strong> 和 <strong>signature</strong> 是校验值，修改后需要对其进行修复</li>
<li><strong>string_ids</strong>, <strong>type_ids</strong>, <strong>proto_ids</strong>, <strong>field_ids</strong>, <strong>method_ids</strong> 作为类型数组节区（我瞎起的）保存了不同类型的值</li>
<li><strong>class_defs</strong> 存储了类的定义也是我们修改的重点</li>
<li><strong>data</strong> 是数据存储区，包括所有的数据</li>
</ul>
<p><strong>2.类型数组节区</strong><br>类型数组节区包括了<strong>string_ids</strong>, <strong>type_ids</strong>, <strong>proto_ids</strong>, <strong>field_ids</strong>, <strong>method_ids</strong>。分别表示：字符串，类型，函数签名，属性，函数。每个节区都保存了对应类型数据数组，可以用 010Editor 分析二进制文件数据。<br><strong>属性示例：</strong><br><img src="/blog_images/20170206/field_ids.png" alt="field_ids"></p>
<p><strong>3.类定义</strong><br>类定义是修改的重点，这里保存了所有类的结构，也是整个 dex 文件中结构最复杂的部分。其中包括了：静态属性变量、成员数形变量，虚函数，直接函数，静态函数等数据。</p>
<h2 id="0x02-实现功能"><a href="#0x02-实现功能" class="headerlink" title="0x02 实现功能"></a>0x02 实现功能</h2><p>通过分析 dex 文件格式，现在可以实现的混淆加密主要包括四种：</p>
<ol>
<li>静态变量隐藏</li>
<li>函数重复定义</li>
<li>函数隐藏</li>
<li>类定义隐藏</li>
</ol>
<p>四种混淆加密的实现方式都是通过修改 <strong>class_def</strong> 结构体中字段实现的。可以通过 json 格式了解一下 <strong>class_def</strong> 的结构（这里只列出来要用到的字段）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"class_def"</span>: &#123;</div><div class="line">  	<span class="string">"class_idx"</span>: <span class="number">01</span></div><div class="line">  	<span class="string">"static_values_off"</span>: <span class="number">000</span>,       </div><div class="line">  	<span class="string">"class_data_off"</span>: <span class="number">001</span>,          </div><div class="line">  	<span class="string">"class_data"</span>: &#123;                 </div><div class="line">  		<span class="string">"direct_methods_size"</span>: <span class="number">001</span>,  </div><div class="line">  		<span class="string">"virtual_methods_size"</span>: <span class="number">002</span>, </div><div class="line">  		<span class="string">"virtual_methods"</span>:[          </div><div class="line">  			&#123;</div><div class="line">  				<span class="string">"code_off"</span>: <span class="number">003</span> </div><div class="line">  			&#125;,</div><div class="line">  			&#123;</div><div class="line">  				<span class="string">"code_off"</span>: <span class="number">004</span></div><div class="line">  			&#125;</div><div class="line">  		]</div><div class="line">  	&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>字段含义：</p>
<ul>
<li>class_idx: 类名序号，值是type_ids的一个index</li>
<li>class_def: 类定义结构体</li>
<li>static_values_off: 静态变量值偏移</li>
<li>class_data_off: 类定义偏移</li>
<li>class_data: 类定义结构体</li>
<li>direct_methods_size: 直接函数个数</li>
<li>virtual_methods_size: 虚函数个数</li>
<li>virtual_methods: 虚函数结构体</li>
<li>code_off: 函数代码偏移</li>
</ul>
<p>通过上面的字段介绍其实很容易得到四个功能的实现方案，下面一个一个介绍。</p>
<h3 id="1-静态变量隐藏"><a href="#1-静态变量隐藏" class="headerlink" title="1.静态变量隐藏"></a>1.静态变量隐藏</h3><p><strong>static_vaules_off</strong> 保存了每个类中静态变量的值的偏移量，指向 data 区里的一个列表，格式为 <strong>encode_array_item</strong>，如果没有此项内容，该值为0。所以要实现静态变量赋值隐藏只需要将 <strong>static_values_off</strong> 值修改为0。<br><strong>实现效果：</strong><br><img src="/blog_images/20170206/compare-static.png" alt="静态变量隐藏"></p>
<p><em>这里的静态数组数据没有成功隐藏，因为我也不知道怎么搞。😶</em></p>
<h3 id="2-函数重复定义"><a href="#2-函数重复定义" class="headerlink" title="2.函数重复定义"></a>2.函数重复定义</h3><p><strong>class_def -&gt; class_data -&gt; virtual_methods -&gt; code_ff</strong> 表示的是某个类中某个函数的代码偏移地址。这里需要提到一个概念：Java 中所有函数实现都是虚函数，这一点和 C++ 是不一样的，所有这里修改的都是 <strong>virtual_methods</strong> 中 <strong>code_off</strong>。</p>
<p><img src="/blog_images/20170206/virtual_methods.png" alt="virtual_methods"></p>
<p>实现方式:读取第一个函数的代码偏移地址，将接下来的函数偏移地址都修改为第一的值。</p>
<p><strong>实现效果:</strong><br><img src="/blog_images/20170206/compare-mutil-methods.png" alt="mutil-methods"></p>
<h3 id="3-函数隐藏"><a href="#3-函数隐藏" class="headerlink" title="3.函数隐藏"></a>3.函数隐藏</h3><p><strong>class_def -&gt; class_data -&gt; virtual_methods_size</strong> 和 <strong>class_def -&gt; class_data -&gt; direct_methods_size</strong> 记录了类定义中函数的个数,如果没有定义函数则该值为0。所以只要将该值改为0，函数定义就会被隐藏。</p>
<p><strong>实现效果:</strong><br><img src="/blog_images/20170206/compare-hide-methods.png" alt="hide-methods"></p>
<h3 id="4-类定义隐藏"><a href="#4-类定义隐藏" class="headerlink" title="4.类定义隐藏"></a>4.类定义隐藏</h3><p><strong>class_def -&gt; class_data_off</strong> 保存了具体类定义的偏移地址，也就是 <strong>class_def -&gt; class_data</strong> 的地址，如果该值为0则所有实现将被隐藏。隐藏后会把类定义的所有东西都隐藏包括成员变量，成员函数，静态变量，静态函数。</p>
<p><strong>实现效果:</strong><br><img src="/blog_images/20170206/compare-class.png" alt="hide-class"></p>
<h2 id="0x03-数据读取"><a href="#0x03-数据读取" class="headerlink" title="0x03 数据读取"></a>0x03 数据读取</h2><p>上面一个章节主要介绍了功能实现的原理，接下来要介绍具体实现了。要实现修改 <strong>class_def</strong> 中字段，首先要把整个 dex 文件结构解析出来，当然可以只是我们需要的字段。在工具中我定义的 dex 结构如下，因为 <strong>class_def</strong> 结构比较复杂所以独立了一个包定义：    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">→ tree -L 2</div><div class="line">.</div><div class="line">├── DexFile.java</div><div class="line">├── FieldIds.java</div><div class="line">├── Header.java</div><div class="line">├── MapList.java</div><div class="line">├── MethodIds.java</div><div class="line">├── ProtoIds.java</div><div class="line">├── StringIds.java</div><div class="line">├── TypeIds.java</div><div class="line">└── cladef</div><div class="line">    ├── ClassData.java</div><div class="line">    ├── ClassDefs.java</div><div class="line">    ├── Code.java</div><div class="line">    ├── EncodedField.java</div><div class="line">    ├── EncodedMethod.java</div><div class="line">    ├── EncodedValue.java</div><div class="line">    └── StaticValues.java</div></pre></td></tr></table></figure>
<p>也许你可能会疑问，我们功能实现时候只需要修改 <strong>class_def</strong> 为什么还需要读取 <strong>string_ids</strong> 这些区段。这是因为像上面提到的 <strong>class_def -&gt; class_idx</strong> 保存的其实是 <strong>type_ids</strong> 中的序号，而 <strong>type_ids</strong> 中保存的是 <strong>string_ids</strong> 的序号。</p>
<p>为了灵活配置，运行工具的时候我们只需要配置好要隐藏的类名，比如需要隐藏某个类的实现 <code>hack_me_size: cc.gnaixx.samp.core.EntranceImpl</code>, 配置文件的具体实现下个章节介绍。</p>
<p><strong>DexFile.java</strong> 定义了整个 dex 文件结构, 实现比较简单只有一个 <strong>read(byte[] dexBuff)</strong> 函数读取整个 dex 文件格式。</p>
<p><strong>DexFile.java:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DexFile</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HEADER_LEN = <span class="number">0x70</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> Header header;</div><div class="line">    <span class="keyword">public</span> StringIds stringIds;</div><div class="line">    <span class="keyword">public</span> TypeIds typeIds;</div><div class="line">    <span class="keyword">public</span> ProtoIds protoIds;</div><div class="line">    <span class="keyword">public</span> FieldIds fieldIds;</div><div class="line">    <span class="keyword">public</span> MethodIds methodIds;</div><div class="line">    <span class="keyword">public</span> ClassDefs classDefs;</div><div class="line">    <span class="keyword">public</span> MapList mapList;</div><div class="line"></div><div class="line">    <span class="comment">//reader dex</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">byte</span>[] dexBuff)</span></span>&#123;</div><div class="line">        <span class="comment">//read header</span></div><div class="line">        <span class="keyword">byte</span>[] headerbs = subdex(dexBuff, <span class="number">0</span>, HEADER_LEN);</div><div class="line">        header = <span class="keyword">new</span> Header(headerbs);</div><div class="line"></div><div class="line">        <span class="comment">//read string_ids</span></div><div class="line">        stringIds = <span class="keyword">new</span> StringIds(dexBuff, header.stringIdsOff, header.stringIdsSize);</div><div class="line"></div><div class="line">        <span class="comment">//read type_ids</span></div><div class="line">        typeIds = <span class="keyword">new</span> TypeIds(dexBuff, header.typeIdsOff, header.typeIdsSize);</div><div class="line"></div><div class="line">        <span class="comment">//read proto_ids</span></div><div class="line">        protoIds = <span class="keyword">new</span> ProtoIds(dexBuff, header.protoIdsOff, header.protoIdsSize);</div><div class="line"></div><div class="line">        <span class="comment">//read field_ids</span></div><div class="line">        fieldIds = <span class="keyword">new</span> FieldIds(dexBuff, header.fieldIdsOff, header.fieldIdsSize);</div><div class="line"></div><div class="line">        <span class="comment">//read method_ids</span></div><div class="line">        methodIds = <span class="keyword">new</span> MethodIds(dexBuff, header.methodIdsOff, header.methodIdsSize);</div><div class="line"></div><div class="line">        <span class="comment">//read class_defs</span></div><div class="line">        classDefs = <span class="keyword">new</span> ClassDefs(dexBuff, header.classDefsOff, header.classDefsSize);</div><div class="line"></div><div class="line">        <span class="comment">//read map_list</span></div><div class="line">        mapList = <span class="keyword">new</span> MapList(dexBuff, header.mapOff);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第一步要先读取 <strong>header</strong> 因为它保存了其他节区的偏移地址和个数。</p>
<p><strong>Header.java:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Header</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[]  magic           = <span class="keyword">new</span> <span class="keyword">byte</span>[MAGIC_LEN];</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     checksum;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[]  signature       = <span class="keyword">new</span> <span class="keyword">byte</span>[SIGNATURE_LEN];</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     fileSize;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     headerSize;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     endianTag;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     linkSize;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     linkOff;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     mapOff;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     stringIdsSize;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     stringIdsOff;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     typeIdsSize;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     typeIdsOff;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     protoIdsSize;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     protoIdsOff;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     fieldIdsSize;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     fieldIdsOff;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     methodIdsSize;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     methodIdsOff;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     classDefsSize;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     classDefsOff;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     dataSize;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>     dataOff;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Header</span><span class="params">(<span class="keyword">byte</span>[] headerBuff)</span> </span>&#123;</div><div class="line">        Reader reader = <span class="keyword">new</span> Reader(headerBuff, <span class="number">0</span>);</div><div class="line">        <span class="keyword">this</span>.magic = reader.subdex(MAGIC_LEN);</div><div class="line">        <span class="keyword">this</span>.checksum = reader.readUint();</div><div class="line">        <span class="keyword">this</span>.signature = reader.subdex(SIGNATURE_LEN);</div><div class="line">        <span class="comment">//......</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">byte</span>[] dexBuff)</span></span>&#123;</div><div class="line">        Writer writer = <span class="keyword">new</span> Writer(dexBuff, <span class="number">0</span>);</div><div class="line">        writer.replace(magic, MAGIC_LEN);</div><div class="line">        writer.writeUint(checksum);</div><div class="line">        writer.replace(signature, SIGNATURE_LEN);</div><div class="line">        <span class="comment">//.....</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>知道了各个节区的偏移地址和个数接下来的读取就比较简单了，比如 <strong>string_ids</strong> 节区的读取。</p>
<p><strong>StringIds.java:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringIds</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">StringId</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> dataOff;            <span class="comment">//字符串偏移位置</span></div><div class="line">        Uleb128 utf16Size;      <span class="comment">//字符串长度</span></div><div class="line">        <span class="keyword">byte</span> data[];            <span class="comment">//字符串数据</span></div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">StringId</span><span class="params">(<span class="keyword">int</span> dataOff, Uleb128 uleb128, <span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.dataOff = dataOff;</div><div class="line">            <span class="keyword">this</span>.utf16Size = uleb128;</div><div class="line">            <span class="keyword">this</span>.data = data;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    StringId stringIds[];</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StringIds</span><span class="params">(<span class="keyword">byte</span>[] dexBuff, <span class="keyword">int</span> off, <span class="keyword">int</span> size)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.stringIds = <span class="keyword">new</span> StringId[size];</div><div class="line"></div><div class="line">        Reader reader = <span class="keyword">new</span> Reader(dexBuff, off);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">            <span class="keyword">int</span> dataOff = reader.readUint();</div><div class="line">            Uleb128 utf16Size = getUleb128(dexBuff, dataOff);</div><div class="line">            <span class="keyword">byte</span>[] data = subdex(dexBuff, dataOff + <span class="number">1</span>, utf16Size.getVal());</div><div class="line">            StringId stringId = <span class="keyword">new</span> StringId(dataOff, utf16Size, data);</div><div class="line">            stringIds[i] = stringId;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getData</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">        <span class="comment">//return "(" + id + ")" + new String(stringIds[id].data);</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(stringIds[id].data);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其他节区的读取和 <strong>string_ids</strong> 类似，但是 <strong>class_def</strong> 节区结构比较复杂，读取起来可能比较麻烦。但是其实我们要用的值并不是很多，只需要关注那几个字段就好了。</p>
<p><strong>ClassDefs.java:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassDefs</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassDef</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span>          classIdx;       <span class="comment">//class类型，对应type_ids</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span>          accessFlags;    <span class="comment">//访问类型，enum</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span>          superclassIdx;  <span class="comment">//supperclass类型，对应type_ids</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span>          interfacesOff;  <span class="comment">//接口偏移，对应type_list</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span>          sourceFileIdx;  <span class="comment">//源文件名，对应string_ids</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span>          annotationsOff; <span class="comment">//class注解，位置位于data区，对应annotation_direcotry_item</span></div><div class="line">        <span class="keyword">public</span> HackPoint    classDataOff;   <span class="comment">//class具体用到的数据，位于data区，格式为class_data_item,描述class的field,method,method执行代码</span></div><div class="line">        <span class="keyword">public</span> HackPoint    staticValueOff; <span class="comment">//位于data区，格式为encoded_array_item</span></div><div class="line"></div><div class="line">        <span class="keyword">public</span> StaticValues staticValues;  <span class="comment">// classDataOff不为0时存在</span></div><div class="line">        <span class="keyword">public</span> ClassData    classData;     <span class="comment">// staticValueOff不为0存在</span></div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ClassDef</span><span class="params">(<span class="keyword">int</span> classIdx, <span class="keyword">int</span> accessFlags,</span></span></div><div class="line">                        <span class="keyword">int</span> superclassIdx, <span class="keyword">int</span> interfacesOff,</div><div class="line">                        <span class="keyword">int</span> sourceFileidx, <span class="keyword">int</span> annotationsOff,</div><div class="line">                        HackPoint classDataOff, HackPoint staticValueOff) &#123;</div><div class="line">            <span class="keyword">this</span>.classIdx = classIdx;</div><div class="line">            <span class="keyword">this</span>.accessFlags = accessFlags;</div><div class="line">            <span class="keyword">this</span>.superclassIdx = superclassIdx;</div><div class="line">            <span class="keyword">this</span>.interfacesOff = interfacesOff;</div><div class="line">            <span class="keyword">this</span>.sourceFileIdx = sourceFileidx;</div><div class="line">            <span class="keyword">this</span>.annotationsOff = annotationsOff;</div><div class="line">            <span class="keyword">this</span>.classDataOff = classDataOff;</div><div class="line">            <span class="keyword">this</span>.staticValueOff = staticValueOff;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClassData</span><span class="params">(ClassData classData)</span></span>&#123;</div><div class="line">            <span class="keyword">this</span>.classData = classData;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStaticValue</span><span class="params">(StaticValues staticValues)</span></span>&#123;</div><div class="line">            <span class="keyword">this</span>.staticValues = staticValues;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span>      offset; <span class="comment">//偏移位置</span></div><div class="line">    <span class="keyword">int</span>      size;   <span class="comment">//大小</span></div><div class="line"></div><div class="line">    <span class="keyword">public</span> ClassDef classDefs[];</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClassDefs</span><span class="params">(<span class="keyword">byte</span>[] dexBuff, <span class="keyword">int</span> off, <span class="keyword">int</span> size)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.offset = off;</div><div class="line">        <span class="keyword">this</span>.size = size;</div><div class="line"></div><div class="line">        Reader reader = <span class="keyword">new</span> Reader(dexBuff, off);</div><div class="line">        classDefs = <span class="keyword">new</span> ClassDef[size];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">            <span class="keyword">int</span> classIdx = reader.readUint();</div><div class="line">            <span class="keyword">int</span> accessFlags = reader.readUint();</div><div class="line">            <span class="keyword">int</span> superclassIdx = reader.readUint();</div><div class="line">            <span class="keyword">int</span> interfacesOff = reader.readUint();</div><div class="line">            <span class="keyword">int</span> sourcFileIdx = reader.readUint();</div><div class="line">            <span class="keyword">int</span> annotationOff = reader.readUint();</div><div class="line"></div><div class="line">            HackPoint classDataOff = <span class="keyword">new</span> HackPoint(HackPoint.UINT, reader.getOff(), reader.readUint());</div><div class="line">            HackPoint staticValueOff = <span class="keyword">new</span> HackPoint(HackPoint.UINT, reader.getOff(), reader.readUint());</div><div class="line"></div><div class="line">            ClassDef classDef = <span class="keyword">new</span> ClassDef(</div><div class="line">                    classIdx, accessFlags,</div><div class="line">                    superclassIdx, interfacesOff,</div><div class="line">                    sourcFileIdx, annotationOff,</div><div class="line">                    classDataOff, staticValueOff);</div><div class="line"></div><div class="line">            <span class="keyword">if</span>(staticValueOff.value != <span class="number">0</span>)&#123;</div><div class="line">                Reader reader1 = <span class="keyword">new</span> Reader(dexBuff, staticValueOff.value);</div><div class="line">                Uleb128 staticSize = reader1.readUleb128();</div><div class="line">                StaticValues staticValues = <span class="keyword">new</span> StaticValues(staticSize);</div><div class="line">                classDef.setStaticValue(staticValues);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span>(classDataOff.value != <span class="number">0</span>)&#123;</div><div class="line">                classDef.setClassData(<span class="keyword">new</span> ClassData(dexBuff, classDataOff.value));</div><div class="line">            &#125;</div><div class="line">            classDefs[i] = classDef;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">byte</span>[] dexBuff)</span></span>&#123;</div><div class="line">        Writer writer = <span class="keyword">new</span> Writer(dexBuff, offset);</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;size; i++)&#123;</div><div class="line">            ClassDef classDef = classDefs[i];</div><div class="line">            writer.writeUint(classDef.classIdx);</div><div class="line">            writer.writeUint(classDef.accessFlags);</div><div class="line">            writer.writeUint(classDef.superclassIdx);</div><div class="line">            writer.writeUint(classDef.interfacesOff);</div><div class="line">            writer.writeUint(classDef.sourceFileIdx);</div><div class="line">            writer.writeUint(classDef.annotationsOff);</div><div class="line"></div><div class="line">            writer.writeUint(classDef.classDataOff.value);</div><div class="line">            <span class="keyword">if</span>(classDef.classDataOff.value != <span class="number">0</span>)&#123;</div><div class="line">                classDef.classData.write(dexBuff, classDef.classDataOff.value);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            writer.writeUint(classDef.staticValueOff.value);</div><div class="line">            <span class="keyword">if</span>(classDef.staticValueOff.value != <span class="number">0</span>)&#123;</div><div class="line">                <span class="comment">//暂时不做处理</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里需要介绍一下 dex 特有的一种数据类型 <strong>LEB128</strong> 官方介绍如下：</p>
<blockquote>
<p>LEB128 (“Little-Endian Base 128”) is a variable-length encoding for arbitrary signed or unsigned integer quantities. The format was borrowed from the DWARF3 specification. In a .dex file, LEB128 is only ever used to encode 32-bit quantities.</p>
<p>Each LEB128 encoded value consists of one to five bytes, which together represent a single 32-bit value. Each byte has its most significant bit set except for the final byte in the sequence, which has its most significant bit clear. The remaining seven bits of each byte are payload, with the least significant seven bits of the quantity in the first byte, the next seven in the second byte and so on. In the case of a signed LEB128 (sleb128), the most significant payload bit of the final byte in the sequence is sign-extended to produce the final value. In the unsigned case (uleb128), any bits not explicitly represented are interpreted as 0.</p>
</blockquote>
<p><img src="/blog_images/20170206/leb128.png" alt="leb128"></p>
<p>也就是说 LEB128 是基于 1 个 Byte 的一种不定长度的编码方式 。若第一个 Byte 的最高位为 1 ，则表示还需要下一个 Byte 来描述 ，直至最后一个 Byte 的最高 位为 0 。每个 Byte 的其余 Bit 用来表示数据。</p>
<p>代码中用 ULeb128.java(unsigned 无符号) 表示是该结构，通过分析Android源码 <a href="https://github.com/android/platform_dalvik/blob/master/libdex/Leb128.h" target="_blank" rel="external">Leb128.h</a>可以知道 LEB128 虽然表示的是不定长格式，但是在 Android 中只用到了4 个byte，所以只需要用int表示就可以了。</p>
<p><strong>ULeb128.java：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Uleb128</span> </span>&#123;</div><div class="line">    <span class="keyword">byte</span>[] realVal; <span class="comment">//存储的byte数据</span></div><div class="line">    <span class="keyword">int</span> val; <span class="comment">//表示的整型数据</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Uleb128</span><span class="params">(<span class="keyword">byte</span>[] realVal, <span class="keyword">int</span> val)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.realVal = realVal;</div><div class="line">        <span class="keyword">this</span>.val = val;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.realVal.length;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getVal</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.val;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getRealVal()&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.realVal;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>Bytes to ULEB128:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Reader.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> Uleb128 <span class="title">readUleb128</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> value = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">        <span class="keyword">byte</span> realVal[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</div><div class="line">        <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            flag = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">byte</span> seg = buffer[offset];</div><div class="line">            <span class="keyword">if</span> ((seg &amp; <span class="number">0x80</span>) == <span class="number">0x80</span>) &#123; <span class="comment">//高8位为1</span></div><div class="line">                flag = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            seg = (<span class="keyword">byte</span>) (seg &amp; <span class="number">0x7F</span>);</div><div class="line">            value += seg &lt;&lt; (<span class="number">7</span> * count);</div><div class="line">            realVal[count] = buffer[offset];</div><div class="line">            count++;</div><div class="line">            offset++;</div><div class="line">        &#125; <span class="keyword">while</span> (flag);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Uleb128(BufferUtil.subdex(realVal, <span class="number">0</span>, count), value);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><strong>Integer to ULEB128:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Trans.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Uleb128 <span class="title">intToUleb128</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">        <span class="keyword">byte</span>[] realVal = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>&#125;; <span class="comment">//int 最大长度为4</span></div><div class="line">        <span class="keyword">int</span> bk = val;</div><div class="line">        <span class="keyword">int</span> len = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; realVal.length; i++) &#123;</div><div class="line">            len = i + <span class="number">1</span>; <span class="comment">//最少长度为1</span></div><div class="line">            realVal[i] = (<span class="keyword">byte</span>) (val &amp; <span class="number">0x7F</span>); <span class="comment">//获取低7位的值</span></div><div class="line">            <span class="keyword">if</span> (val &gt; (<span class="number">0x7F</span>)) &#123;</div><div class="line">                realVal[i] |= <span class="number">0x80</span>; <span class="comment">//高位为1 加上去</span></div><div class="line">            &#125;</div><div class="line">            val = val &gt;&gt; <span class="number">7</span>;</div><div class="line">            <span class="keyword">if</span> (val &lt;= <span class="number">0</span>) <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        Uleb128 uleb128 = <span class="keyword">new</span> Uleb128(BufferUtil.subdex(realVal, <span class="number">0</span>, len), bk);</div><div class="line">        <span class="keyword">return</span> uleb128;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="0x04-HackPoint格式"><a href="#0x04-HackPoint格式" class="headerlink" title="0x04 HackPoint格式"></a>0x04 HackPoint格式</h2><p><strong>HackPoint</strong> 表示修改后的数据结构,代码中把所有要修改的的字段都用 <strong>HackPoint</strong> 类型表示。<strong>HackPoint</strong> 类型有三个字段 type、offset、value，都是 int 类型分别表示：类型、偏移地址、原始值。类型主要有三种 <strong>uint(unsigned int)、ushort(unsigned short 2byte)、uleb128</strong>。这三种数据用 int 存储都足够了。<br><strong>HackPoint.java:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HackPoint</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UINT = <span class="number">0x01</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> USHORT = <span class="number">0x02</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ULEB128 = <span class="number">0x03</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> type;        <span class="comment">//数据类型</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> offset;      <span class="comment">//偏移地址</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> value;       <span class="comment">//原始值</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HackPoint</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">int</span> offset, <span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.type = type;</div><div class="line">        <span class="keyword">this</span>.offset = offset;</div><div class="line">        <span class="keyword">this</span>.value = val;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> HackPoint <span class="title">clone</span><span class="params">()</span> </span>&#123;</div><div class="line">        HackPoint hp = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            hp = (HackPoint) <span class="keyword">super</span>.clone();</div><div class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> hp;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在修改完后会把所有的 <strong>HackPoint</strong> 数据写在 dex 文件的末尾。本来 dex 文件末尾是 <strong>map_list</strong> 区段，数据格式是 :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> map_list&#123;</div><div class="line">	ushort type;</div><div class="line">	ushort unused;</div><div class="line">	uint size;</div><div class="line">	uint offset;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>刚好是 12 byte, 所以 <strong>HackPoint</strong> 写入 dex 文件的格式为:</p>
<p><img src="/blog_images/20170206/hp.png" alt="hp"></p>
<h2 id="0x05-配置文件"><a href="#0x05-配置文件" class="headerlink" title="0x05 配置文件"></a>0x05 配置文件</h2><p>配置文件的定义比较简单看一下示例就知道了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">####################################################</span></div><div class="line"><span class="comment">#    hack_class:      隐藏类定义</span></div><div class="line"><span class="comment">#    hack_sf_val:     隐藏静态变量</span></div><div class="line"><span class="comment">#    hack_me_size:    隐藏methods</span></div><div class="line"><span class="comment">#    hack_me_def:     重复函数定义（以第一个为准）</span></div><div class="line"><span class="comment">#####################################################</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#隐藏静态变量值</span></div><div class="line">hack_sf_val: cc.gnaixx.samp.core.EntranceImpl</div><div class="line"></div><div class="line"><span class="comment">#重复函数定义（以第一个为准）</span></div><div class="line">hack_me_def: cc.gnaixx.samp.core.EntranceImpl</div><div class="line"></div><div class="line"><span class="comment">#隐藏函数实现</span></div><div class="line">hack_me_size: cc.gnaixx.samp.core.EntranceImpl</div><div class="line"></div><div class="line"><span class="comment">#隐藏整个类实现</span></div><div class="line">hack_class: cc.gnaixx.samp.core.EntranceImpl cc.gnaixx.samp.BuildConfig</div></pre></td></tr></table></figure>
<p><em>当多个类需要实现同一个功能的时候只需要用空格分隔就可以了</em></p>
<p>配置文件读取代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; readConfig(String path) &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Map&lt;String, List&lt;String&gt;&gt; config = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        FileReader fr = <span class="keyword">new</span> FileReader(path);</div><div class="line">        BufferedReader br = <span class="keyword">new</span> BufferedReader(fr);</div><div class="line">        String line;</div><div class="line">        <span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (!line.startsWith(<span class="string">"#"</span>) &amp;&amp; !line.equals(<span class="string">""</span>)) &#123;</div><div class="line">                String conf[] = line.split(<span class="string">":"</span>);</div><div class="line">                <span class="keyword">if</span> (conf.length != <span class="number">2</span>) &#123;</div><div class="line">                    log(<span class="string">"warning"</span>, <span class="string">"error config at :"</span> + line);</div><div class="line">                    System.exit(<span class="number">0</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                String key = conf[<span class="number">0</span>];</div><div class="line">                String values[] = conf[<span class="number">1</span>].split(<span class="string">" "</span>);</div><div class="line">                List&lt;String&gt; valueList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</div><div class="line">                    <span class="keyword">if</span> (values[i] != <span class="keyword">null</span> &amp;&amp; !values[i].equals(<span class="string">""</span>)) &#123;</div><div class="line">                        valueList.add(values[i]);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                config.put(key, valueList);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        fr.close();</div><div class="line">        br.close();</div><div class="line">        <span class="keyword">return</span> config;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x06-dex混淆隐藏"><a href="#0x06-dex混淆隐藏" class="headerlink" title="0x06 dex混淆隐藏"></a>0x06 dex混淆隐藏</h2><p>dex 文件混淆隐藏主要包括三个步骤：</p>
<ol>
<li>修改 <strong>HackPoint</strong> 并保存到 dex 文件末尾</li>
<li>修复Header</li>
</ol>
<h3 id="1-修改-HackPoint"><a href="#1-修改-HackPoint" class="headerlink" title="1.修改 HackPoint"></a>1.修改 HackPoint</h3><p>通过取得的配置文件中的配置类遍历 <strong>class_def_item</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//查找配置文件所在类位置</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">seekHP</span><span class="params">(ClassDefs.ClassDef[] classDefItem, List&lt;String&gt; conf, String type, SeekCallBack callBack)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span> (conf == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; conf.size(); i++) &#123;</div><div class="line">        String classname = conf.get(i);</div><div class="line">        <span class="keyword">boolean</span> isDef = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; classDefItem.length; j++) &#123;</div><div class="line">            String className = dexFile.typeIds.getString(dexFile, classDefItem[j].classIdx); <span class="comment">//查找顺序 class_idx =&gt; type_ids =&gt; string_ids</span></div><div class="line">            className = pathToPackages(className); <span class="comment">//获取类名</span></div><div class="line">            <span class="keyword">if</span> (className.equals(classname)) &#123;</div><div class="line">                callBack.doHack(classDefItem[j], <span class="keyword">this</span>.hackPoints); <span class="comment">//具体操作</span></div><div class="line">                log(type, conf.get(i));</div><div class="line">                isDef = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (isDef == <span class="keyword">false</span>) &#123;</div><div class="line">            log(<span class="string">"warning"</span>, <span class="string">"con't find class:"</span> + classname);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//具体操作回调处理</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SeekCallBack</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doHack</span><span class="params">(ClassDefs.ClassDef classDefItem, List&lt;HackPoint&gt; hackPoints)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>隐藏静态变量值:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//隐藏静态变量初始化</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hackSfVal</span><span class="params">(ClassDefs.ClassDef[] classDefItem, List&lt;String&gt; conf)</span> </span>&#123;</div><div class="line">    seekHP(classDefItem, conf, Constants.HACK_SF_VAL, <span class="keyword">new</span> SeekCallBack() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doHack</span><span class="params">(ClassDefs.ClassDef classDefItem, List&lt;HackPoint&gt; hackPoints)</span> </span>&#123;</div><div class="line">            HackPoint point = classDefItem.staticValueOff.clone();  <span class="comment">//获取静态变量数据偏移</span></div><div class="line">            hackPoints.add(point);                          <span class="comment">//添加修改点</span></div><div class="line">            classDefItem.staticValueOff.value = <span class="number">0</span>;          <span class="comment">//将静态变量的偏移改为0（隐藏赋值）</span></div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>函数重复定义:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//重复函数定义</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hackMeDef</span><span class="params">(ClassDefs.ClassDef[] classDefItem, List&lt;String&gt; conf)</span></span>&#123;</div><div class="line">    seekHP(classDefItem, conf, Constants.HACK_ME_DEF, <span class="keyword">new</span> SeekCallBack() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doHack</span><span class="params">(ClassDefs.ClassDef classDefItem, List&lt;HackPoint&gt; hackPoints)</span> </span>&#123;</div><div class="line">            <span class="comment">//以第一个为默认值</span></div><div class="line">            <span class="keyword">int</span> virtualMeSize = classDefItem.classData.virtualMethodsSize.value;</div><div class="line">            <span class="keyword">int</span> virtualMeCodeOff = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; virtualMeSize; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</div><div class="line">                    virtualMeCodeOff = classDefItem.classData.virtualMethods[i].codeOff.value;</div><div class="line">                &#125;<span class="keyword">else</span>&#123;</div><div class="line">                    HackPoint point = classDefItem.classData.virtualMethods[i].codeOff.clone();</div><div class="line">                    hackPoints.add(point);</div><div class="line">                    classDefItem.classData.virtualMethods[i].codeOff.value = virtualMeCodeOff;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>函数隐藏：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//隐藏函数定义</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hackMeSize</span><span class="params">(ClassDefs.ClassDef[] classDefItem, List&lt;String&gt; conf)</span></span>&#123;</div><div class="line">    seekHP(classDefItem, conf, Constants.HACK_ME_SIZE, <span class="keyword">new</span> SeekCallBack() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doHack</span><span class="params">(ClassDefs.ClassDef classDefItem, List&lt;HackPoint&gt; hackPoints)</span> </span>&#123;</div><div class="line">            HackPoint directPoint = classDefItem.classData.directMethodsSize.clone(); <span class="comment">//同时需改虚函数和直接函数</span></div><div class="line">            HackPoint virtualPoint = classDefItem.classData.virtualMethodsSize.clone();</div><div class="line">            hackPoints.add(directPoint);</div><div class="line">            hackPoints.add(virtualPoint);</div><div class="line">            classDefItem.classData.directMethodsSize.value = <span class="number">0</span>;</div><div class="line">            classDefItem.classData.virtualMethodsSize.value = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>隐藏类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//隐藏静态变量初始化</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hackSfVal</span><span class="params">(ClassDefs.ClassDef[] classDefItem, List&lt;String&gt; conf)</span> </span>&#123;</div><div class="line">    seekHP(classDefItem, conf, Constants.HACK_SF_VAL, <span class="keyword">new</span> SeekCallBack() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doHack</span><span class="params">(ClassDefs.ClassDef classDefItem, List&lt;HackPoint&gt; hackPoints)</span> </span>&#123;</div><div class="line">            HackPoint point = classDefItem.staticValueOff.clone();  <span class="comment">//获取静态变量数据偏移</span></div><div class="line">            hackPoints.add(point);                          <span class="comment">//添加修改点</span></div><div class="line">            classDefItem.staticValueOff.value = <span class="number">0</span>;          <span class="comment">//将静态变量的偏移改为0（隐藏赋值）</span></div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>添加 HackPoint 数据到 dex 文件：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">//保留修改信息</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendHP</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">byte</span>[] pointsBuff = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;&#125;;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; hackPoints.size(); i++) &#123;</div><div class="line">        <span class="keyword">byte</span>[] pointBuff = hackpToBin(hackPoints.get(i));</div><div class="line">        pointsBuff = BufferUtil.append(pointsBuff, pointBuff, pointBuff.length);</div><div class="line">    &#125;</div><div class="line">    dexBuff = BufferUtil.append(dexBuff, pointsBuff, pointsBuff.length);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//hackPoint 转 二进制</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] hackpToBin(HackPoint point) &#123;</div><div class="line">    ByteBuffer bb = ByteBuffer.allocate(<span class="number">4</span> * <span class="number">3</span>);</div><div class="line">    bb.put(intToBin_Lit(point.type));</div><div class="line">    bb.put(intToBin_Lit(point.offset));</div><div class="line">    bb.put(intToBin_Lit(point.value));</div><div class="line">    <span class="keyword">return</span> bb.array();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//小端二进制</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] intToBin_Lit(<span class="keyword">int</span> integer)&#123;</div><div class="line">    <span class="keyword">byte</span>[] bin = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;</div><div class="line">            (<span class="keyword">byte</span>) ((integer &gt;&gt; <span class="number">0</span>) &amp; <span class="number">0xFF</span>),</div><div class="line">            (<span class="keyword">byte</span>) ((integer &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>),</div><div class="line">            (<span class="keyword">byte</span>) ((integer &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>),</div><div class="line">            (<span class="keyword">byte</span>) ((integer &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>)</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">return</span> bin;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>dex 文件都是以小端数据保存</em></p>
<h3 id="2-修复Header"><a href="#2-修复Header" class="headerlink" title="2.修复Header"></a>2.修复Header</h3><p><strong>Header</strong> 中修复的数据有三个：</p>
<ol>
<li>文件长度 </li>
<li>checksum</li>
<li>signature</li>
</ol>
<p><strong>修改代码:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//修改header</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hackHeader</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//修改文件长度</span></div><div class="line">    Header header = dexFile.header;</div><div class="line">    header.fileSize = <span class="keyword">this</span>.dexBuff.length;</div><div class="line">    header.write(dexBuff); <span class="comment">//需要先修改文件长度，才能计算signature checksum</span></div><div class="line">    <span class="comment">//修复 signature 校验</span></div><div class="line">    log(<span class="string">"old_signature"</span>, binToHex(dexFile.header.signature));</div><div class="line">    <span class="keyword">byte</span>[] signature = signature(dexBuff, SIGNATURE_LEN + SIGNATURE_OFF);</div><div class="line">    header.signature = signature;</div><div class="line">    log(<span class="string">"new_signature"</span>, binToHex(signature));</div><div class="line">    header.write(dexBuff); <span class="comment">//需要先写sinature,才能计算checksum，凸</span></div><div class="line">    <span class="comment">//修复 checksum 校验</span></div><div class="line">    log(<span class="string">"old_checksum"</span>, intToHex(dexFile.header.checksum));</div><div class="line">    <span class="keyword">int</span> checksum = checksum_Lit(dexBuff, CHECKSUM_LEN + CHECKSUM_OFF);</div><div class="line">    header.checksum = checksum;</div><div class="line">    log(<span class="string">"new_checksum"</span>, intToHex(checksum));</div><div class="line">    header.write(dexBuff);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//计算signature</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] signature(<span class="keyword">byte</span>[] data, <span class="keyword">int</span> off) &#123;</div><div class="line">    <span class="keyword">int</span> len = data.length - off;</div><div class="line">    <span class="keyword">byte</span>[] signature = SHA1(data, off, len);</div><div class="line">    <span class="keyword">return</span> signature;</div><div class="line">&#125;</div><div class="line"><span class="comment">//sha1算法</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] SHA1(<span class="keyword">byte</span>[] decript, <span class="keyword">int</span> off, <span class="keyword">int</span> len) &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        MessageDigest digest = MessageDigest.getInstance(<span class="string">"SHA-1"</span>);</div><div class="line">        digest.update(decript, off, len);</div><div class="line">        <span class="keyword">byte</span> messageDigest[] = digest.digest();</div><div class="line">        <span class="keyword">return</span> messageDigest;</div><div class="line">    &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//计算checksum 值</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">checksum_Lit</span><span class="params">(<span class="keyword">byte</span>[] data, <span class="keyword">int</span> off)</span> </span>&#123;</div><div class="line">    <span class="keyword">byte</span>[] bin = checksum_bin(data, off);</div><div class="line">    <span class="keyword">int</span> value = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; UINT_LEN; i++) &#123;</div><div class="line">        <span class="keyword">int</span> seg = bin[i];</div><div class="line">        <span class="keyword">if</span> (seg &lt; <span class="number">0</span>) &#123;</div><div class="line">            seg = <span class="number">256</span> + seg;</div><div class="line">        &#125;</div><div class="line">        value += seg &lt;&lt; (<span class="number">8</span> * i);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> value;</div><div class="line">&#125;</div><div class="line"><span class="comment">//计算checksum</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] checksum_bin(<span class="keyword">byte</span>[] data, <span class="keyword">int</span> off) &#123;</div><div class="line">    <span class="keyword">int</span> len = data.length - off;</div><div class="line">    Adler32 adler32 = <span class="keyword">new</span> Adler32();</div><div class="line">    adler32.reset();</div><div class="line">    adler32.update(data, off, len);</div><div class="line">    <span class="keyword">long</span> checksum = adler32.getValue();</div><div class="line">    <span class="keyword">byte</span>[] checksumbs = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;</div><div class="line">            (<span class="keyword">byte</span>) checksum,</div><div class="line">            (<span class="keyword">byte</span>) (checksum &gt;&gt; <span class="number">8</span>),</div><div class="line">            (<span class="keyword">byte</span>) (checksum &gt;&gt; <span class="number">16</span>),</div><div class="line">            (<span class="keyword">byte</span>) (checksum &gt;&gt; <span class="number">24</span>)&#125;;</div><div class="line">    <span class="keyword">return</span> checksumbs;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该部分代码地址: <strong><a href="https://github.com/gnaixx/hidex-hack/blob/master/hidex-tool/src/main/java/cc/gnaixx/tools/core/HidexHandle.java" target="_blank" rel="external">HidexHandle.java</a></strong></p>
<h2 id="0x07-dex还原"><a href="#0x07-dex还原" class="headerlink" title="0x07 dex还原"></a>0x07 dex还原</h2><p>相对于加密解密过程简单了很多，只要根据 <strong>HackPoint</strong> 数据一一修复就好了。这里简单的说下修复步骤：</p>
<ol>
<li>读取 Header 中 <strong>map_list</strong> 的偏移地址和个数，因为 <strong>HackPoint</strong> 数据保存在 <strong>map_list</strong> 之后</li>
<li>读取 <strong>HackPoint</strong> 数据并修复 dex 文件</li>
<li>修复 Header 中的 <strong>file_size、checksum、signature</strong></li>
</ol>
<h3 id="java-实现"><a href="#java-实现" class="headerlink" title="java 实现"></a>java 实现</h3><p>修复关键源码：    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//修复dex文件</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] redex() &#123;</div><div class="line">    <span class="keyword">int</span> mapOff = getUint(dexBuff, MAP_OFF_OFF); <span class="comment">//获取map_off</span></div><div class="line">    <span class="keyword">int</span> mapSize = getUint(dexBuff, mapOff); <span class="comment">//获取map_size</span></div><div class="line">    <span class="keyword">int</span> hackInfoStart = mapOff + UINT_LEN + (mapSize * MAP_ITEM_LEN); <span class="comment">//获取 hackinfo 开始地址</span></div><div class="line">    <span class="keyword">int</span> hackInfoLen = dexBuff.length - hackInfoStart; <span class="comment">//获取hackinfo 长度</span></div><div class="line">    hackInfoBuff = subdex(dexBuff, hackInfoStart, hackInfoLen); <span class="comment">//获取hack数据</span></div><div class="line">    <span class="keyword">int</span> dexLen = dexBuff.length - hackInfoLen;</div><div class="line">    dexBuff = subdex(dexBuff, <span class="number">0</span>, dexLen); <span class="comment">//截取原始dex长度</span></div><div class="line">    HackPoint[] hackPoints = Trans.binToHackP(hackInfoBuff);  <span class="comment">//修复hack点</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; hackPoints.length; i++) &#123;</div><div class="line">        log(<span class="string">"hackPoint"</span>, JSON.toJSONString(hackPoints[i]));</div><div class="line">        recovery(hackPoints[i]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">byte</span>[] fileSize = intToBin_Lit(dexLen); <span class="comment">//修复文件长度</span></div><div class="line">    replace(dexBuff, fileSize, FILE_SIZE_OFF, UINT_LEN);</div><div class="line">    <span class="keyword">byte</span>[] signature = signature(dexBuff, SIGNATURE_LEN + SIGNATURE_OFF); <span class="comment">//修复signature校验</span></div><div class="line">    replace(dexBuff, signature, SIGNATURE_OFF, SIGNATURE_LEN);</div><div class="line">    <span class="keyword">byte</span>[] checksum = checksum_bin(dexBuff, CHECKSUM_LEN + CHECKSUM_OFF); <span class="comment">//修复checksum校验</span></div><div class="line">    replace(dexBuff, checksum, CHECKSUM_OFF, CHECKSUM_LEN);</div><div class="line">    log(<span class="string">"fileSize"</span>, dexLen);</div><div class="line">    log(<span class="string">"signature"</span>, binToHex(signature));</div><div class="line">    log(<span class="string">"checksum"</span>, binToHex_Lit(checksum));</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.dexBuff;</div><div class="line">&#125;</div><div class="line"><span class="comment">//还原原始值</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recovery</span><span class="params">(HackPoint hackPoint)</span> </span>&#123;</div><div class="line">    Writer writer = <span class="keyword">new</span> Writer(<span class="keyword">this</span>.dexBuff, hackPoint.offset);</div><div class="line">    <span class="keyword">if</span> (hackPoint.type == HackPoint.USHORT) &#123;</div><div class="line">        writer.writeUshort(hackPoint.value);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (hackPoint.type == HackPoint.UINT) &#123;</div><div class="line">        writer.writeUint(hackPoint.value);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (hackPoint.type == HackPoint.ULEB128) &#123;</div><div class="line">        Uleb128 uleb128 = Trans.intToUleb128(hackPoint.value);</div><div class="line">        writer.writeUleb128(uleb128);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="c-实现"><a href="#c-实现" class="headerlink" title="c++ 实现"></a>c++ 实现</h3><p>工具本身就是为了实现安全加固，那么用 java 实现意义就小了很多，所以工具包里面的实现我是用 NDK 开发的。</p>
<p>修复关键源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//解密dex</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">recode</span><span class="params">(<span class="keyword">char</span>* source, uint sourceLen, <span class="keyword">char</span>* target, uint* targetLen)</span></span>&#123;</div><div class="line">    uint mapOff = readUint(source, MAP_OFF_OFF); <span class="comment">//获取map_off</span></div><div class="line">    uint mapSize = readUint(source, mapOff); <span class="comment">//获取map_size</span></div><div class="line">    LOGD(<span class="string">"mapInfo: &#123;map_off:%d, map_size:%d&#125;"</span>, mapOff, mapSize);</div><div class="line"></div><div class="line">    uint hackInfoOff = mapOff + UINT_LEN + (mapSize * MAP_ITEM_LEN); <span class="comment">//定位hackInfo位置</span></div><div class="line">    uint hackInfoLen = sourceLen - hackInfoOff; <span class="comment">//hackInfo长度</span></div><div class="line">    <span class="keyword">char</span>* hackInfo = (<span class="keyword">char</span> *) calloc(hackInfoLen, sizeof(<span class="keyword">char</span>));</div><div class="line">    memcpy(hackInfo, source + hackInfoOff, hackInfoLen); <span class="comment">//复制hackInfo</span></div><div class="line">    LOGD(<span class="string">"hackInfo: &#123;hackInfo_off:%d, hackInfo_len&#125;"</span>, hackInfoOff, hackInfoLen);</div><div class="line"></div><div class="line">    uint hackPointSize = hackInfoLen / sizeof(HackPoint); <span class="comment">//获取hackPoint结构体</span></div><div class="line">    HackPoint* hackPoints = (HackPoint *) calloc(hackPointSize, sizeof(HackPoint));</div><div class="line">    initHP(hackPoints, hackInfo, hackPointSize); <span class="comment">//将hockInfo 转化为结构体</span></div><div class="line"></div><div class="line">    *targetLen = hackInfoOff;</div><div class="line">    memcpy(target, source, *targetLen); <span class="comment">//恢复原始长度</span></div><div class="line"></div><div class="line">    <span class="comment">//恢复数据</span></div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;hackPointSize; i++)&#123;</div><div class="line">        recoverHP(target, hackPoints[i]);</div><div class="line">    &#125;</div><div class="line">    LOGD(<span class="string">"Recover HackPoint success"</span>);</div><div class="line"></div><div class="line">    <span class="comment">//修复hearder</span></div><div class="line">    recoverHeader(target, *targetLen);</div><div class="line"></div><div class="line">    free(hackInfo);</div><div class="line">    free(hackPoints);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完整源码地址: <strong><a href="https://github.com/gnaixx/hidex-hack/blob/master/hidex-libs/src/main/cpp/hidex.cpp" target="_blank" rel="external">hidex.cpp</a></strong></p>
<h2 id="0x09-总结"><a href="#0x09-总结" class="headerlink" title="0x09 总结"></a>0x09 总结</h2><p>整体功能还是比较简单，实现的代码也不是很复杂，但是这些都需要基于对 dex 文件格式的了解的前提下。<br>另外该工具存在一个缺点，dex 的加载问题。Android中加载 dex 的 DexClassLoad 只支持文件路径加载，不像 java 中的 ClassLoad 可以支持二进制流加载，所以在加载 dex 是就存在加密后的 dex 缓存，这是非常危险的。所以下个研究的点也就是自定义 DexClassLoad 实现不落地加载。（很多安全加固厂商老早就实现了🙄）。<br>虽然功能不算强大，也有不少缺点，不过也花了自己不少时间研究，对 dex 文件格式也有点了解，也算值得了。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>赏一个呗！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/wechatpay.png" alt="凸一_一凸 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/alipay.jpg" alt="凸一_一凸 Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android/" rel="tag">#android</a>
          
            <a href="/tags/dex/" rel="tag">#dex</a>
          
            <a href="/tags/hidex/" rel="tag">#hidex</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/11/26/20161126dex-file/" rel="next" title="DEX文件格式分析">
                <i class="fa fa-chevron-left"></i> DEX文件格式分析
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/02/06/20170206hidex-hack/"
           data-title="DEX文件混淆加密" data-url="http://gnaixx.github.io/2017/02/06/20170206hidex-hack/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/custom_avatar.jpg"
               alt="凸一_一凸" />
          <p class="site-author-name" itemprop="name">凸一_一凸</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">40</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">41</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/gnaixx" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://waynecz.github.io/" title="wayne" target="_blank">wayne</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x00-前言"><span class="nav-number">1.</span> <span class="nav-text">0x00 前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-dex格式分析"><span class="nav-number">2.</span> <span class="nav-text">0x01 dex格式分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-实现功能"><span class="nav-number">3.</span> <span class="nav-text">0x02 实现功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-静态变量隐藏"><span class="nav-number">3.1.</span> <span class="nav-text">1.静态变量隐藏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-函数重复定义"><span class="nav-number">3.2.</span> <span class="nav-text">2.函数重复定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-函数隐藏"><span class="nav-number">3.3.</span> <span class="nav-text">3.函数隐藏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-类定义隐藏"><span class="nav-number">3.4.</span> <span class="nav-text">4.类定义隐藏</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-数据读取"><span class="nav-number">4.</span> <span class="nav-text">0x03 数据读取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-HackPoint格式"><span class="nav-number">5.</span> <span class="nav-text">0x04 HackPoint格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-配置文件"><span class="nav-number">6.</span> <span class="nav-text">0x05 配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-dex混淆隐藏"><span class="nav-number">7.</span> <span class="nav-text">0x06 dex混淆隐藏</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-修改-HackPoint"><span class="nav-number">7.1.</span> <span class="nav-text">1.修改 HackPoint</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-修复Header"><span class="nav-number">7.2.</span> <span class="nav-text">2.修复Header</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-dex还原"><span class="nav-number">8.</span> <span class="nav-text">0x07 dex还原</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#java-实现"><span class="nav-number">8.1.</span> <span class="nav-text">java 实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#c-实现"><span class="nav-number">8.2.</span> <span class="nav-text">c++ 实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x09-总结"><span class="nav-number">9.</span> <span class="nav-text">0x09 总结</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">凸一_一凸</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"gnaix"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

  


</body>
</html>

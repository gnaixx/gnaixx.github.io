---
title: DEXæ–‡ä»¶æ ¼å¼åˆ†æ
tags: [android, dex]
toc: true
date: 2016-11-26 18:07:27
categories: android
description: å‰æ®µæ—¶é—´å¿™äºç ´è§£ç§»åŠ¨å’Œç”µä¿¡çš„ apk ,æŒºä¹…æ²¡æœ‰æ›´æ–°åšå®¢äº†ï¼Œæœ€è¿‘åœ¨å†™ä¸ªå·¥å…·ï¼Œä¸»è¦åŠŸèƒ½æ˜¯é€šè¿‡é…ç½®å¯¹ dex æ–‡ä»¶ä¸­çš„ç±»å‹ã€å‡½æ•°ã€å±æ€§è¿›è¡Œéšè—ï¼Œè¾¾åˆ°é˜²æ­¢è¢«é™æ€åˆ†æçš„æ•ˆæœã€‚æ‰€ä»¥åœ¨å†™å·¥å…·å‰å¿…é¡»å¯¹ dex çš„æ–‡ä»¶æ ¼å¼æœ‰ä¸ªæ¸…æ™°çš„è®¤è¯†ï¼Œç›¸å¯¹äº elf æ–‡ä»¶æ ¼å¼ dex æ–‡ä»¶æ ¼å¼ä¼šç®€å•ä¸€äº›ã€‚

---

## 0x00 å‰è¨€
åˆ†æ dex æ–‡ä»¶æ ¼å¼æœ€å¥½çš„æ–¹å¼æ˜¯æ‰¾ä¸ªä»‹ç»æ–‡æ¡£ï¼Œè‡ªå·±å†å†™ä¸€ä¸ªç®€å•çš„ demo ç„¶åç”¨ 010Editor å¯¹ç…§ç€åˆ†æã€‚æ–‡æ¡£å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£[http://source.android.com/devices/tech/dalvik/dex-format.html](http://source.android.com/devices/tech/dalvik/dex-format.html),è‹±æ–‡å·®çš„ä¹Ÿå¯ä»¥æ‰¾ä¸ªä¸­æ–‡çš„ï¼Œæ¯”å¦‚è¯´æˆ‘ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚

010Editor è¿™ä¸ªå·¥å…·æ¯”è¾ƒå¥½ç”¨ï¼Œä¹‹å‰åˆ†æ elf æ–‡ä»¶ä¹Ÿæ˜¯ç”¨çš„å®ƒã€‚å…¶å®åªè¦è£…äº†æ¨¡æ¿ï¼Œå¯ä»¥åˆ†æå¾ˆå¤šæ–‡ä»¶ã€‚è™½ç„¶æ˜¯æ”¶è´¹è½¯ä»¶ï¼Œæœ‰30å¤©å…è´¹è¯•ç”¨ã€‚**ä½†æ˜¯å¦‚æœä½ ç”¨çš„æ˜¯ mac ğŸ˜ è¯•ç”¨æœŸåˆ°äº†, åˆ ä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶ ğŸ™„** `~/.config/SweetScape/010 Editor.ini`ã€‚

## 0x01 æ–‡ä»¶å¸ƒå±€
dex æ–‡ä»¶å¯ä»¥åˆ†ä¸º3ä¸ªæ¨¡å—ï¼Œå¤´æ–‡ä»¶(header)ã€ç´¢å¼•åŒº(xxxx_ids)ã€æ•°æ®åŒº(data)ã€‚å¤´æ–‡ä»¶æ¦‚å†µçš„æè¿°äº†æ•´ä¸ª dex æ–‡ä»¶çš„åˆ†å¸ƒï¼ŒåŒ…æ‹¬æ¯ä¸€ä¸ªç´¢å¼•åŒºçš„å¤§å°è·Ÿåç§»ã€‚ç´¢å¼•åŒºçš„ids æ˜¯ `identifiers` çš„ç¼©å†™ï¼Œè¡¨ç¤ºæ¯ä¸ªæ•°æ®çš„æ ‡è¯†ï¼Œç´¢å¼•åŒºä¸»è¦æ˜¯æŒ‡å‘æ•°æ®åŒºçš„åç§»ã€‚

![dexæ–‡ä»¶å¸ƒå±€](http://gnaixx.cc/blog_images/20161129/1.png)

010Editor ä¸­é™¤äº†æ•°æ®åŒº(data)æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥ï¼Œå…¶ä»–åŒºæ®µéƒ½æœ‰æ˜¾ç¤ºï¼Œå¦å¤– link_data åœ¨æ¨¡æ¿ä¸­è¢«å®šä¸º map_list

![010Editorå¸ƒå±€](http://gnaixx.cc/blog_images/20161129/2.png)

## 0x02 header
header æè¿°äº† dex æ–‡ä»¶ä¿¡æ¯ï¼Œå’Œå…¶ä»–å„ä¸ªåŒºçš„ç´¢å¼•ã€‚010Editor(å†™010Editor æœ‰ç‚¹éº»çƒ¦ä¸‹é¢ç›´æ¥å†™010)ä¸­ç”¨ç»“æ„ä½“ `struct header_item` æ¥æè¿° headerã€‚

![header](http://gnaixx.cc/blog_images/20161129/3.png)

å…¶ä¸­ç”¨åˆ°äº†ä¸¤ç§æ•°æ®ç±»å‹charã€uintã€‚è¿™é‡Œçš„ char æ˜¯ C/C++ ä¸­çš„char å  8-bit, java ä¸­çš„ char æ˜¯å  16-bit æœ‰ç‚¹åŒºåˆ«ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä»–æ¥è¡¨ç¤º short/ushort è¿™ä¸ªä»¥åä»‹ç»æœ€è¿‘å†™çš„å·¥å…·ä¼šä»‹ç»ã€‚å®˜æ–¹æ–‡æ¡£æ˜¯ç”¨ ubyteæ¥å®šä¹‰çš„ï¼Œé‚£è¿˜æ˜¯æŒ‰å®˜æ–¹çš„æ¥å§ã€‚
ç»“æ„ä½“æè¿°ï¼š

```c++
ubyte 8-bit unsinged int
uint  32-bit unsigned int, little-endian

struct header_item 
{
	ubyte[8]  magic;
	unit      checksum; 
	ubyte[20] signature; 
	uint      file_size; 
	uint      header_size; 
	unit      endian_tag; 
	uint      link_size; 
	uint      link_off; 
	uint      map_off;
	uint      string_ids_size; 
	uint      string_ids_off; 
	uint      type_ids_size; 
	uint      type_ids_off; 
	uint      proto_ids_size; 
	uint      proto_ids_off; 
	uint      method_ids_size; 
	uint      method_ids_off; 
	uint      class_defs_size; 
	uint      class_defs_off; 
	uint      data_size;
	uint      data_off; 
}
```

é™¤äº† magicã€checksumã€signatureã€file_sizeã€endian_tagã€map_off å…¶ä»–å…ƒç´ éƒ½æ˜¯æˆå¯¹å‡ºç°çš„ã€‚_off è¡¨ç¤ºå…ƒç´ çš„åç§»é‡ï¼Œ_size è¡¨ç¤ºå…ƒç´ çš„ä¸ªæ•°ã€‚å…¶ä½™çš„6ä¸ªæè¿°ä¸»è¦æ˜¯ dex æ–‡ä»¶çš„ä¿¡æ¯ã€‚

- magic: è¿™ä¸ªæ˜¯å›ºå®šå€¼ï¼Œç”¨äºè¯†åˆ« dex æ–‡ä»¶ã€‚è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ä¸ºï¼š

```java
{0x64, 0x65, 0x78, 0x0A, 0x30, 0x33, 0x35, 0x00} = "dex\n035\0"
```
ä¸­é—´æ˜¯ä¸€ä¸ªæ¢è¡Œï¼Œåé¢035æ˜¯ç‰ˆæœ¬å·ã€‚

- checksum: æ–‡ä»¶æ ¡éªŒç ï¼Œä½¿ç”¨ alder32 ç®—æ³•æ ¡éªŒæ–‡ä»¶é™¤å» maigcã€checksum å¤–ä½™ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åŒºåŸŸï¼Œç”¨äºæ£€ æŸ¥æ–‡ä»¶é”™è¯¯ã€‚
- signature: ä½¿ç”¨ SHA-1 ç®—æ³• hash é™¤å» magicã€checksum å’Œ signature å¤–ä½™ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åŒºåŸŸï¼Œ ç”¨äºå”¯ä¸€è¯†åˆ«æœ¬æ–‡ä»¶ ã€‚
- file_size: dex æ–‡ä»¶å¤§å°
- header_size: header åŒºåŸŸçš„å¤§å°ï¼Œç›®å‰æ˜¯å›ºå®šä¸º 0x70
- endian_tag: å¤§å°ç«¯æ ‡ç­¾ï¼Œdex æ–‡ä»¶æ ¼å¼ä¸ºå°ç«¯ï¼Œå›ºå®šå€¼ä¸º 0x12345678 å¸¸é‡
- map_off: map_item çš„åç§»åœ°å€ï¼Œè¯¥ item å±äº data åŒºé‡Œçš„å†…å®¹ï¼Œå€¼è¦å¤§äºç­‰äº data_off çš„å¤§å°ï¼Œå¤„äº dex æ–‡ä»¶çš„æœ«ç«¯ã€‚

## 0x03 string_ids
string_ids åŒºæ®µæè¿°äº† dex æ–‡ä»¶ä¸­æ‰€æœ‰çš„å­—ç¬¦ä¸²ã€‚æ ¼å¼å¾ˆç®€å•åªæœ‰ä¸€ä¸ªåç§»é‡ï¼Œåç§»é‡æŒ‡å‘äº† string_data åŒºæ®µçš„ä¸€ä¸ªå­—ç¬¦ä¸²ï¼š

![string_ids](http://gnaixx.cc/blog_images/20161129/6.png)

ä¸Šè¿°æè¿°é‡Œæåˆ°äº† LEB128 ( little endian base 128 ) æ ¼å¼ï¼Œæ˜¯åŸºäº 1 ä¸ª byte çš„ä¸€ç§ä¸å®šé•¿åº¦çš„ç¼–ç æ–¹å¼ã€‚è‹¥ç¬¬ä¸€ä¸ª byte çš„æœ€é«˜ä½ä¸º1ï¼Œåˆ™è¡¨ç¤ºè¿˜éœ€è¦ä¸‹ä¸€ä¸ª byte æ¥æè¿°ï¼Œç›´è‡³æœ€åä¸€ä¸ª byte çš„æœ€é«˜ä½ä¸º 0ã€‚æ¯ä¸ª byte çš„å…¶ä½™ bit ç”¨æ¥è¡¨ç¤ºæ•°æ®ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚å®é™…ä¸­ LEB128 æœ€å¤§åªèƒ½è¾¾åˆ° 32-bit å¯ä»¥é˜…è¯» dalvik ä¸­çš„[Leb128.h](https://android.googlesource.com/platform/dalvik/+/eclair-release/libdex/Leb128.h)æºç çœ‹å‡ºæ¥ã€‚

![leb128](http://gnaixx.cc/blog_images/20161129/7.png)

æ•°æ®ç»“æ„ä¸ºï¼š

```c++
ubyte    8-bit unsinged int
uint     32-bit unsigned int, little-endian
uleb128  unsigned LEB128, valriable length

struct string_ids_item
{
	uint string_data_off;
}

struct string_data_item 
{
	uleb128 utf16_size;
	ubyte   data; 
}
```

å…¶ä¸­ data ä¿å­˜çš„å°±æ˜¯å­—ç¬¦ä¸²çš„å€¼ã€‚string_ids æ˜¯æ¯”è¾ƒå…³é”®çš„ï¼Œåç»­çš„åŒºæ®µå¾ˆå¤šéƒ½æ˜¯ç›´æ¥æŒ‡å‘ string_ids çš„ indexã€‚åœ¨å†™å·¥å…·è¿›è¡Œæ¯”è¾ƒçš„æ—¶å€™ä¹Ÿéœ€è¦æå–åˆ° string_idsã€‚

## 0x04 type_ids
type_ids åŒºç´¢å¼•äº† dex æ–‡ä»¶é‡Œçš„æ‰€æœ‰æ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬ class ç±»å‹ï¼Œæ•°ç»„ç±»å‹(array types)å’ŒåŸºæœ¬ç±»å‹(primitive types)ã€‚åŒºæ®µé‡Œçš„å…ƒç´ æ ¼å¼ä¸º type_ids_itemï¼Œç»“æ„æè¿°å¦‚ä¸‹ : 

```c++
uint 32-bit unsigned int, little-endian

struct type_ids_item
{
	uint descriptor_idx;  //-->string_ids
}
```
type_ids_item é‡Œé¢ descriptor_idx çš„å€¼çš„æ„æ€ï¼Œæ˜¯ string_ids é‡Œçš„ index åºå·ï¼Œæ˜¯ç”¨æ¥æè¿°æ­¤ type çš„å­—ç¬¦ä¸²ã€‚

## 0x05 proto_ids
proto çš„æ„æ€æ˜¯ method prototype ä»£è¡¨ java è¯­è¨€é‡Œçš„ä¸€ä¸ª method çš„åŸå‹ ã€‚proto_ids é‡Œçš„å…ƒç´ ä¸º proto_id_itemï¼Œç»“æ„å¦‚ä¸‹:

```c++
uint 32-bit unsigned int, little-endian 

struct proto_id_item
{
	uint shorty_idx;		//-->string_ids
	uint return_type_idx;	//-->type_ids
	uint parameters_off;
}
```

- shorty_idx: è·Ÿ type_ids ä¸€æ ·ï¼Œå®ƒçš„å€¼æ˜¯ä¸€ä¸ª string_ids çš„ index å· ï¼Œæœ€ç»ˆæ˜¯ä¸€ä¸ªç®€çŸ­çš„å­—ç¬¦ä¸²æè¿°ï¼Œç”¨æ¥è¯´æ˜è¯¥ method åŸå‹ã€‚- return_type_idx: å®ƒçš„å€¼æ˜¯ä¸€ä¸ª type_ids çš„ index å· ï¼Œè¡¨ç¤ºè¯¥ method åŸå‹çš„è¿”å›å€¼ç±»å‹ã€‚
- parameters_off: æŒ‡å‘ method åŸå‹çš„å‚æ•°åˆ—è¡¨ type_listï¼Œè‹¥ method æ²¡æœ‰å‚æ•°ï¼Œå€¼ä¸º0ã€‚å‚æ•°åˆ—è¡¨çš„æ ¼å¼æ˜¯ type_listï¼Œä¸‹é¢ä¼šæœ‰æè¿°ã€‚

## 0x06 field_ids
filed_ids åŒºé‡Œé¢æœ‰ dex æ–‡ä»¶å¼•ç”¨çš„æ‰€æœ‰çš„ fieldã€‚åŒºæ®µçš„å…ƒç´ æ ¼å¼æ˜¯ field_id_itemï¼Œç»“æ„å¦‚ä¸‹:

```c++
ushort 16-bit unsigned int, little-endian 
uint   32-bit unsigned int, little-endian 

struct filed_id_item
{
	ushort class_idx;  //-->type_ids
	ushort type_idx;   //-->type_ids
	uint   name_idx;   //-->string_ids
}```

- class_idx: è¡¨ç¤º field æ‰€å±çš„ class ç±»å‹ï¼Œclass_idx çš„å€¼æ˜¯ type_ids çš„ä¸€ä¸ª indexï¼Œå¹¶ä¸”å¿…é¡»æŒ‡å‘ä¸€ä¸ª class ç±»å‹ã€‚
- type_idx: è¡¨ç¤ºæœ¬ field çš„ç±»å‹ï¼Œå®ƒçš„å€¼ä¹Ÿæ˜¯ type_ids çš„ä¸€ä¸ª index ã€‚
- name_idx: è¡¨ç¤ºæœ¬ field çš„åç§°ï¼Œå®ƒçš„å€¼æ˜¯ string_ids çš„ä¸€ä¸ª index ã€‚

## 0x07 method_ids
method_ids æ˜¯ç´¢å¼•åŒºçš„æœ€åä¸€ä¸ªæ¡ç›®ï¼Œæè¿°äº† dex æ–‡ä»¶é‡Œçš„æ‰€æœ‰çš„ methodã€‚method_ids çš„å…ƒç´ æ ¼å¼æ˜¯ method_id_itemï¼Œç»“æ„è·Ÿ fields_ids å¾ˆç›¸ä¼¼:

```c
ushort 16-bit unsigned int, little-endian 
uint   32-bit unsigned int, little-endian 

struct filed_id_item
{
	ushort class_idx;  //-->type_ids
	ushort proto_idx;   //-->proto_ids
	uint   name_idx;   //-->string_ids
}
```

- class_idx: è¡¨ç¤º method æ‰€å±çš„ class ç±»å‹ï¼Œclass_idx çš„å€¼æ˜¯ type_ids çš„ä¸€ä¸ª indexï¼Œå¹¶ä¸”å¿…é¡»æŒ‡å‘ä¸€ä¸ª class ç±»å‹ã€‚<font color=red>ushortç±»å‹ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¯´ä¸€ä¸ª dex åªèƒ½æœ‰ 65535 ä¸ªæ–¹æ³•çš„åŸå› ï¼Œå¤šäº†å¿…é¡»åˆ†åŒ…</font>ã€‚
- proto_idx: è¡¨ç¤º method çš„ç±»å‹ï¼Œå®ƒçš„å€¼ä¹Ÿæ˜¯ type_ids çš„ä¸€ä¸ª indexã€‚
- name_idx: è¡¨ç¤º method çš„åç§°ï¼Œå®ƒçš„å€¼æ˜¯ string_ids çš„ä¸€ä¸ª indexã€‚

## 0x08 class_defs
class_def åŒºæ®µä¸»è¦æ˜¯å¯¹ class çš„å®šä¹‰ï¼Œå®ƒçš„ç»“æ„å¾ˆå¤æ‚ï¼Œçœ‹çš„æˆ‘æœ‰ç‚¹æ™•ï¼Œä¸€å±‚å¥—ä¸€å±‚ã€‚å…ˆçœ‹ä¸€å¼  010 çš„ç»“æ„å›¾ï¼š

![class_defs](http://gnaixx.cc/blog_images/20161129/8.png)

çœ‹ç€éƒ½æ™•ï¼Œåˆ«è¯´è§£æçš„æ—¶å€™äº†ã€‚

### class_def_item
class_def_item ç»“æ„æè¿°å¦‚ä¸‹ï¼š

```c++
uint   32-bit unsigned int, little-endian

struct class_def_item
{
	uint class_idx;     	//-->type_ids   
	uint access_flags;		
	uint superclass_idx;	//-->type_ids
	uint interface_off;     //-->type_list
	uint source_file_idx;	//-->string_ids
	uint annotations_off;	//-->annotation_directory_item
	uint class_data_off;	//-->class_data_item
	uint static_value_off;	//-->encoded_array_item
}
```

- class_idx: æè¿°å…·ä½“çš„ class ç±»å‹ï¼Œå€¼æ˜¯ type_ids çš„ä¸€ä¸ª index ã€‚å€¼å¿…é¡»æ˜¯ä¸€ä¸ª class ç±»å‹ï¼Œä¸èƒ½æ˜¯æ•°ç»„ç±»å‹æˆ–è€…åŸºæœ¬ç±»å‹ã€‚
- access_flags: æè¿° class çš„è®¿é—®ç±»å‹ï¼Œè¯¸å¦‚ public , final , static ç­‰ã€‚åœ¨ dex-format.html é‡Œ "access_flags Definitions" æœ‰å…·ä½“çš„æè¿° ã€‚- superclass_idx: æè¿° supperclass çš„ç±»å‹ï¼Œå€¼çš„å½¢å¼è·Ÿ class_idx ä¸€æ · ã€‚- interfaces_off: å€¼ä¸ºåç§»åœ°å€ï¼ŒæŒ‡å‘ class çš„ interfacesï¼Œè¢«æŒ‡å‘çš„æ•°æ®ç»“æ„ä¸º `type_list` ã€‚class è‹¥æ²¡æœ‰ interfaces å€¼ä¸º 0ã€‚- source_file_idx: è¡¨ç¤ºæºä»£ç æ–‡ä»¶çš„ä¿¡æ¯ï¼Œå€¼æ˜¯ string_ids çš„ä¸€ä¸ª indexã€‚è‹¥æ­¤é¡¹ä¿¡æ¯ç¼ºå¤±ï¼Œæ­¤é¡¹å€¼èµ‹å€¼ä¸º NO_INDEX=0xffff ffffã€‚- annotions_off: å€¼æ˜¯ä¸€ä¸ªåç§»åœ°å€ï¼ŒæŒ‡å‘çš„å†…å®¹æ˜¯è¯¥ class çš„æ³¨é‡Šï¼Œä½ç½®åœ¨ data åŒºï¼Œæ ¼å¼ä¸º `annotations_direcotry_item`ã€‚è‹¥æ²¡æœ‰æ­¤é¡¹å†…å®¹ï¼Œå€¼ä¸º 0 ã€‚- class_data_off: å€¼æ˜¯ä¸€ä¸ªåç§»åœ°å€ï¼ŒæŒ‡å‘çš„å†…å®¹æ˜¯è¯¥ class çš„ä½¿ç”¨åˆ°çš„æ•°æ®ï¼Œä½ç½®åœ¨ data åŒºï¼Œæ ¼å¼ä¸º `class_data_item`ã€‚è‹¥æ²¡æœ‰æ­¤é¡¹å†…å®¹å€¼ä¸º 0ã€‚è¯¥ç»“æ„é‡Œæœ‰å¾ˆå¤šå†…å®¹ï¼Œè¯¦ç»†æè¿°è¯¥ class çš„ fieldã€method, method é‡Œçš„æ‰§è¡Œä»£ç ç­‰ä¿¡æ¯ï¼Œåé¢ä¼šä»‹ç» `class_data_item`ã€‚- static_value_off: å€¼æ˜¯ä¸€ä¸ªåç§»åœ°å€ ï¼ŒæŒ‡å‘ data åŒºé‡Œçš„ä¸€ä¸ªåˆ—è¡¨ (list)ï¼Œæ ¼å¼ä¸º `encoded_array_item`ã€‚è‹¥æ²¡æœ‰æ­¤é¡¹å†…å®¹å€¼ä¸º 0ã€‚

### type_list
type_list åœ¨ data åŒºæ®µï¼Œclass_def_item->interface_off å°±æ˜¯æŒ‡çš„è¿™é‡Œçš„æ•°æ®ã€‚æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š

```c++
uint   32-bit unsigned int, little-endian

struct type_list
{
	uint       size;
	type_item  list [size] 
}

struct type_item
{
	ushort type_idx   //-->type_ids
}
```

- size: è¡¨ç¤ºç±»å‹ä¸ªæ•°
- type_idx: å¯¹åº”ä¸€ä¸ª type_ids çš„ index

### annotations_directory_item
class_def_item->annotations_off æŒ‡å‘çš„æ•°æ®åŒºæ®µï¼Œå®šä¹‰äº† annotation ç›¸å…³çš„æ•°æ®æè¿°ï¼Œæ•°æ®ç»“æ„å¦‚ä¸‹ï¼š

```c++
uint   32-bit unsigned int, little-endian

struct annotation_directory_item
{
	uint class_annotations_off;		//-->annotation_set_item
	uint fields_size;
	uint annotated_methods_size;
	uint annotated_parameters_size;
	
	field_annotation field_annotations[fields_size];
	method_annotation method_annotations[annotated_methods_size];
	parameter_annotation parameter_annotations[annotated_parameters_size];
}

struct field_annotation
{
	uint field_idx;
	uint annotations_off;	//-->annotation_set_item
}

struct method_annotation
{
	uint method_idx;
	uint annotations_off;	//-->annotation_set_item
}

struct parameter_annotation
{
	uint method_idx;
	uint annotations_off;	//-->annotation_set_ref_list
}
```

- class_annotations_off: è¿™ä¸ªåç§»æŒ‡å‘äº† `annotation_set_item ` å…·ä½“çš„å¯ä»¥çœ‹ [dex-format.html](http://source.android.com/devices/tech/dalvik/dex-format.html) ä¸Šçš„ä»‹ç»ã€‚
- fields_size: è¡¨ç¤ºå±æ€§çš„ä¸ªæ•°
- annotated_methods_size: è¡¨ç¤ºæ–¹æ³•çš„ä¸ªæ•°
- annotated_parameters_size: è¡¨ç¤ºå‚æ•°çš„ä¸ªæ•°

### class_data_item
class_data_off æŒ‡å‘ data åŒºé‡Œçš„ class_data_item ç»“æ„ï¼Œclass_data_item é‡Œå­˜æ”¾ç€æœ¬ class ä½¿ç”¨åˆ°çš„å„ç§æ•°æ®ï¼Œä¸‹é¢æ˜¯ class_data_item çš„ç»“æ„ :

```c++
uleb128 unsigned little-endian base 128 

struct class_data_item
{
	uleb128 static_fields_size;
	uleb128 instance_fields_size;
	uleb128 direct_methods_size;
	uleb128 virtual_methods_size;

	encoded_field  static_fields[static_fields_size];
	encoded_field  instance_fields[instance_fields_size];
	encoded_method direct_methods[direct_methods_size];
	encoded_method virtual_methods[virtual_methods_size];
}

struct encoded_field
{
	uleb128 filed_idx_diff; 
	uleb128 access_flags;  
}

struct encoded_method
{
	uleb128 method_idx_diff; 
	uleb128 access_flags; 
	uleb128 code_off;
}
```

**class_data_item**

- static_fields_size: é™æ€æˆå‘˜å˜é‡çš„ä¸ªæ•°
- instance_fields_size: å®ä¾‹æˆå‘˜å˜é‡ä¸ªæ•°
- direct_methods_size: ç›´æ¥å‡½æ•°ä¸ªæ•°
- virtual_methods_size: è™šå‡½æ•°ä¸ªæ•°

ä¸‹é¢å‡ ä¸ªå°±æ˜¯å¯¹äºçš„æè¿°

**encoded_field**

- method_idx_diff: å‰ç¼€ methd_idx è¡¨ç¤ºå®ƒçš„å€¼æ˜¯ method_ids çš„ä¸€ä¸ª index ï¼Œåç¼€ _diff è¡¨ç¤ºå®ƒæ˜¯äºå¦ å¤–ä¸€ä¸ª method_idx çš„ä¸€ä¸ªå·®å€¼ ï¼Œå°±æ˜¯ç›¸å¯¹äº encodeed_method [] æ•°ç»„é‡Œä¸Šä¸€ä¸ªå…ƒç´ çš„ method_idx çš„å·®å€¼ ã€‚ å…¶å® encoded_filed - > field_idx_diff è¡¨ç¤ºçš„ä¹Ÿæ˜¯ç›¸åŒçš„æ„æ€ ï¼Œåªæ˜¯ç¼–è¯‘å‡ºæ¥çš„ Hello.dex æ–‡ä»¶é‡Œæ²¡æœ‰ä½¿ç”¨åˆ° class filed æ‰€ä»¥æ²¡æœ‰ä»”ç»†è®² ï¼Œè¯¦ç»†çš„å‚è€ƒ dex_format.html çš„å®˜ç½‘æ–‡æ¡£ã€‚- access_flags: è®¿é—®æƒé™ï¼Œæ¯”å¦‚ publicã€privateã€staticã€final ç­‰ã€‚- code_off: ä¸€ä¸ªæŒ‡å‘ data åŒºçš„åç§»åœ°å€ï¼Œç›®æ ‡æ˜¯æœ¬ method çš„ä»£ç å®ç°ã€‚è¢«æŒ‡å‘çš„ç»“æ„æ˜¯code_itemï¼Œæœ‰è¿‘ 10 é¡¹å…ƒç´ ã€‚

#### code_item
code_item ç»“æ„é‡Œæè¿°ç€æŸä¸ª method çš„å…·ä½“å®ç°ï¼Œå®ƒçš„ç»“æ„æè¿°å¦‚ä¸‹:

```c++
struct code_item 
{
	ushort 						registers_size;
	ushort 						ins_size;
	ushort 						outs_size;
	ushort 						tries_size;
	uint 						debug_info_off;
	uint 						insns_size;
	ushort 						insns [insns_size]; 
	ushort 						paddding; 			// optional
	try_item 					tries [tyies_size]; // optional
	encoded_catch_handler_list  handlers; 			// optional
}
```

æœ«å°¾çš„ 3 é¡¹æ ‡å¿—ä¸º optional , è¡¨ç¤ºå¯èƒ½æœ‰ ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰ ï¼Œæ ¹æ®å…·ä½“çš„ä»£ç æ¥ã€‚
- registers_size: æœ¬æ®µä»£ç ä½¿ç”¨åˆ°çš„å¯„å­˜å™¨æ•°ç›®ã€‚- ins_size: method ä¼ å…¥å‚æ•°çš„æ•°ç›® ã€‚- outs_size: æœ¬æ®µä»£ç è°ƒç”¨å…¶å®ƒ method æ—¶éœ€è¦çš„å‚æ•°ä¸ªæ•° ã€‚- tries_size: try_item ç»“æ„çš„ä¸ªæ•° ã€‚- debug_off: åç§»åœ°å€ï¼ŒæŒ‡å‘æœ¬æ®µä»£ç çš„ debug ä¿¡æ¯å­˜æ”¾ä½ç½®ï¼Œæ˜¯ä¸€ä¸ª `debug_info_item` ç»“æ„ã€‚ 
- insns_size: æŒ‡ä»¤åˆ—è¡¨çš„å¤§å°ï¼Œä»¥ 16-bit ä¸ºå•ä½ã€‚ insns æ˜¯ instructions çš„ç¼©å†™ ã€‚
- padding: å€¼ä¸º 0ï¼Œç”¨äºå¯¹é½å­—èŠ‚ ã€‚- tries å’Œ handlers: ç”¨äºå¤„ç† java ä¸­çš„ exceptionï¼Œå¸¸è§çš„è¯­æ³•æœ‰ try catchã€‚

### encoded_array_item
class_def_item->static_value_off åç§»æŒ‡å‘è¯¥åŒºæ®µæ•°æ®ã€‚

```c++
uleb128  unsigned LEB128, valriable length

struct encoded_array_item
{
	encoded_array value;
}

struct encoded_array
{	
	uleb128 size;
	encoded_value values[size];
}
```

- size : è¡¨ç¤ºencoded_value ä¸ªæ•°
- encoded_value: è¿™ä¸ªæˆ‘ä¹Ÿæ²¡åˆ†æå‡ºæ¥æ€ä¹ˆæå¾—ğŸ™„


## 0x09 map_list
map_list ä¸­å¤§éƒ¨åˆ† item è·Ÿ header ä¸­çš„ç›¸åº”æè¿°ç›¸åŒï¼Œéƒ½æ˜¯ä»‹ç»äº†å„ä¸ªåŒºçš„åç§»å’Œå¤§å°ï¼Œä½†æ˜¯ map_list ä¸­æè¿°çš„æ›´åŠ å…¨é¢ï¼ŒåŒ…æ‹¬äº† HEADER_ITEM ã€TYPE_LISTã€STRING_DATA_ITEMã€DEBUG_INFO_ITEM ç­‰ä¿¡æ¯ã€‚

010 ä¸­map_list è¡¨ç¤ºä¸ºï¼š

![map_list](http://gnaixx.cc/blog_images/20161129/4.png)

æ•°æ®ç»“æ„ä¸ºï¼š

```c++
ushort 16-bit unsigned int, little-endian
uint   32-bit unsigned int, little-endian

struct map_list 
{
	uint     size;
	map_item list [size]; 
}
struct map_item 
{
	ushort type; 
	ushort unuse; 
	uint   size; 
	uint   offset;
}
```
map_list é‡Œå…ˆç”¨ä¸€ä¸ª uint æè¿°åé¢æœ‰ size ä¸ª map_itemï¼Œåç»­å°±æ˜¯å¯¹åº”çš„ size ä¸ª map_item æè¿°ã€‚ map_item ç»“æ„æœ‰ 4 ä¸ªå…ƒç´ : type è¡¨ç¤ºè¯¥ map_item çš„ç±»å‹ï¼ŒDalvik Executable Format é‡Œ Type Code çš„å®šä¹‰; size è¡¨ç¤ºå†ç»†åˆ†æ­¤ itemï¼Œè¯¥ç±»å‹çš„ä¸ªæ•°;offset æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ çš„é’ˆå¯¹æ–‡ä»¶åˆå§‹ä½ç½®çš„åç§»é‡; unuse æ˜¯ç”¨å¯¹é½å­—èŠ‚çš„ï¼Œæ— å®é™…ç”¨å¤„ã€‚

![type_code](http://gnaixx.cc/blog_images/20161129/5.png)